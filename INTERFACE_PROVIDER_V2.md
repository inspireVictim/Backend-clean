# ИНТЕРФЕЙС ПОДКЛЮЧЕНИЯ ПОСТАВЩИКОВ УСЛУГ

**Версия документа:** 2.0  
**Дата публикации:** 2024  
**Статус:** Актуальная версия

---

## СОДЕРЖАНИЕ

1. [Требования к интерфейсу поставщика](#1-требования-к-интерфейсу-поставщика)
2. [Формат входящих запросов](#2-формат-входящих-запросов)
3. [Формат XML-ответов](#3-формат-xml-ответов)
4. [Описание протокола](#4-описание-протокола)
5. [Требования к обработке ошибок](#5-требования-к-обработке-ошибок)
6. [Тайм-ауты и retry-логика](#6-тайм-ауты-и-retry-логика)
7. [Ежедневная сверка](#7-ежедневная-сверка)
8. [Приложение А: Таблица кодов ошибок](#приложение-а-таблица-кодов-ошибок)
9. [Приложение Б: Регулярное выражение для идентификатора абонента](#приложение-б-регулярное-выражение-для-идентификатора-абонента)
10. [Приложение В: Описание сетевой подсети](#приложение-в-описание-сетевой-подсети)
11. [Приложение Г: Примеры запросов и ответов](#приложение-г-примеры-запросов-и-ответов)

---

## 1. ТРЕБОВАНИЯ К ИНТЕРФЕЙСУ ПОСТАВЩИКА

### 1.1. Сетевые требования

**Протокол передачи данных:**
- Интерфейс поставщика **обязан** принимать запросы по протоколу **HTTPS** (HTTP over TLS).
- Поддержка протокола HTTP допускается **только** для тестовых сред и должна быть отключена в production.

**Требования к TLS:**
- Минимальная версия протокола: **TLS 1.2**
- Рекомендуемая версия протокола: **TLS 1.3**
- Использование устаревших протоколов (SSL 3.0, TLS 1.0, TLS 1.1) **запрещено**.
- Сертификат SSL/TLS должен быть валидным и не просроченным.
- Рекомендуется использование сертификатов от доверенных центров сертификации (CA).

**IP-фильтрация:**
- Интерфейс должен принимать запросы **только** с IP-адресов подсети: **79.142.16.0/20**
- Подробное описание подсети см. в [Приложении В](#приложение-в-описание-сетевой-подсети).
- Запросы с IP-адресов, не входящих в указанную подсеть, должны отклоняться с кодом ошибки **403 Forbidden** на уровне веб-сервера или приложения.

**Порты:**
- Стандартный порт для HTTPS: **443**
- Допускается использование нестандартных портов (например, 8443) при условии согласования с технической поддержкой.

### 1.2. Метод передачи данных

**HTTP-метод:**
- Интерфейс должен обрабатывать параметры, передаваемые системой методом **GET**.
- Все параметры передаются в query string URL.

**Альтернативный метод (рекомендуется для версии 2.1+):**
- Для повышения безопасности рекомендуется поддержка метода **POST** с передачей параметров в теле запроса (application/x-www-form-urlencoded или application/json).
- При использовании POST необходимо сохранять обратную совместимость с GET.

### 1.3. Кодировка и формат ответа

**Кодировка:**
- Интерфейс должен формировать ответ системе в формате **XML** в кодировке **UTF-8**.
- Обязательное использование UTF-8 необходимо для корректной обработки символов национальных алфавитов.

**Content-Type:**
- Заголовок ответа должен содержать: `Content-Type: application/xml; charset=utf-8`
- Альтернативно допускается: `Content-Type: text/xml; charset=utf-8`

### 1.4. Производительность и масштабируемость

**Тайм-аут соединения:**
- Скорость ответа интерфейса **не должна превышать 60 секунд**.
- При превышении тайм-аута система разрывает соединение и обрабатывает это как нефатальную ошибку.
- Рекомендуемое время ответа: **не более 5 секунд** для запросов типа `check`, **не более 10 секунд** для запросов типа `pay`.

**Многопоточность:**
- Интерфейс **обязан** поддерживать многопоточную коммуникацию.
- Минимальное количество одновременных соединений: **10-15**
- Для высоконагруженных систем (более 10 платежей в минуту) рекомендуется поддержка **до 50-100 одновременных соединений**.
- Интерфейс должен быть thread-safe и обеспечивать корректную обработку параллельных запросов.

**Rate limiting:**
- Поставщик может применять rate limiting для защиты от перегрузки.
- Рекомендуемые лимиты:
  - Не более **100 запросов в минуту** с одного IP-адреса
  - Не более **1000 запросов в час** с одного IP-адреса
- При превышении лимита должен возвращаться код ошибки **1** (Временная ошибка) с комментарием о превышении лимита.

### 1.5. Логирование и мониторинг

**Требования к логированию:**
- Все входящие запросы должны логироваться с указанием:
  - IP-адрес источника
  - Время запроса (UTC)
  - Параметры запроса (txn_id, account, sum, command)
  - Время обработки
  - Результат обработки (код ошибки)
- Логи должны храниться **минимум 90 дней** для целей аудита и расследования спорных транзакций.
- Рекомендуется использование структурированного логирования (JSON, XML).

**Мониторинг:**
- Рекомендуется предоставление endpoint для health check (например, `/health` или `/status`).
- Endpoint должен возвращать статус доступности сервиса и время ответа.

### 1.6. Идемпотентность

**Требование идемпотентности:**
- Интерфейс должен обеспечивать идемпотентность операций по идентификатору транзакции `txn_id`.
- Если система повторно отправляет запрос с уже существующим в базе поставщика `txn_id`, поставщик **обязан** вернуть результат обработки предыдущего запроса без повторного выполнения операции.
- Это требование критично для предотвращения двойного списания средств.

---

## 2. ФОРМАТ ВХОДЯЩИХ ЗАПРОСОВ

### 2.1. Общие параметры запроса

Все запросы к интерфейсу поставщика содержат следующие обязательные параметры:

| Параметр | Тип | Обязательность | Описание |
|----------|-----|----------------|----------|
| `command` | string | Обязательный | Тип запроса: `check` или `pay` |
| `txn_id` | integer | Обязательный | Уникальный идентификатор транзакции в системе (целое число длиной до 20 знаков) |
| `account` | string | Обязательный | Идентификатор абонента в системе поставщика (строка длиной до 50 символов) |
| `sum` | decimal | Обязательный | Сумма платежа в рублях (дробное число с точностью до сотых, разделитель — точка) |
| `txn_date` | datetime | Условно обязательный | Дата и время платежа в формате `YYYYMMDDHHmmss` (обязателен только для запроса `pay`) |

### 2.2. Описание параметров

**`command`** — тип запроса:
- `check` — запрос на проверку состояния счета абонента и валидацию возможности проведения платежа
- `pay` — запрос на пополнение баланса абонента

**`txn_id`** — уникальный идентификатор транзакции:
- Целое число длиной **до 20 знаков**
- Используется для идентификации платежа в системе
- Должен быть уникальным в рамках всей системы
- Используется для сверки взаиморасчетов и решения спорных вопросов

**`account`** — идентификатор абонента:
- Строка, содержащая буквы (латиница/кириллица), цифры и специальные символы
- Максимальная длина: **50 символов**
- Должен соответствовать регулярному выражению, предоставленному поставщиком (см. [Приложение Б](#приложение-б-регулярное-выражение-для-идентификатора-абонента))
- Перед отправкой запроса система проверяет идентификатор на соответствие регулярному выражению

**`sum`** — сумма платежа:
- Дробное число с точностью **до сотых** (2 знака после запятой)
- Разделитель дробной части: **точка (.)**
- Формат: `XXX.XX` (например, `152.00`, `10.45`, `0.01`)
- Минимальная сумма определяется поставщиком и должна быть указана в договоре
- Максимальная сумма определяется поставщиком и должна быть указана в договоре

**`txn_date`** — дата и время платежа:
- Формат: `YYYYMMDDHHmmss` (14 символов)
- Пример: `20090815120133` (15 августа 2009 года, 12:01:33)
- Временная зона: **московское время (MSK, UTC+3)**
- Обязателен только для запроса типа `pay`
- Для запроса типа `check` не передается

### 2.3. Примеры URL запросов

**Запрос на проверку (check):**
```
https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567890&account=4957835959&sum=10.45
```

**Запрос на пополнение (pay):**
```
https://service.provider.ru:8443/payment_app.cgi?command=pay&txn_id=12345678901234567890&txn_date=20090815120133&account=4957835959&sum=10.45
```

### 2.4. Валидация параметров

Поставщик **обязан** валидировать все входящие параметры:

1. **Проверка обязательных параметров:**
   - Отсутствие обязательного параметра → код ошибки **300** (Другая ошибка поставщика)

2. **Валидация `txn_id`:**
   - Должен быть целым числом
   - Длина не более 20 знаков
   - Не должен быть пустым
   - Нарушение формата → код ошибки **300**

3. **Валидация `account`:**
   - Длина не более 50 символов
   - Соответствие регулярному выражению поставщика
   - Нарушение формата → код ошибки **4** (Неверный формат идентификатора абонента)

4. **Валидация `sum`:**
   - Должно быть положительным числом
   - Формат: `XXX.XX` (дробная часть обязательна)
   - Минимальная сумма → код ошибки **241** (Сумма слишком мала)
   - Максимальная сумма → код ошибки **242** (Сумма слишком велика)
   - Нарушение формата → код ошибки **300**

5. **Валидация `txn_date` (для `pay`):**
   - Формат: `YYYYMMDDHHmmss`
   - Должна быть валидной датой
   - Нарушение формата → код ошибки **300**

---

## 3. ФОРМАТ XML-ОТВЕТОВ

### 3.1. Структура ответа

Поставщик возвращает ответ на запросы системе в формате XML со следующей структурой:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id></osmp_txn_id>
    <prv_txn></prv_txn>
    <sum></sum>
    <result></result>
    <comment></comment>
</response>
```

### 3.2. Описание элементов ответа

| Элемент | Обязательность | Описание |
|---------|----------------|----------|
| `<response>` | Обязательный | Корневой элемент ответа |
| `<osmp_txn_id>` | Обязательный | Номер транзакции в системе, переданный в параметре `txn_id` |
| `<prv_txn>` | Условно обязательный | Уникальный номер операции пополнения баланса в базе поставщика (обязателен только для запроса `pay`) |
| `<sum>` | Обязательный | Сумма платежа в формате `XXX.XX` |
| `<result>` | Обязательный | Код результата завершения запроса (см. [Приложение А](#приложение-а-таблица-кодов-ошибок)) |
| `<comment>` | Необязательный | Комментарий завершения операции (может быть пустым) |

### 3.3. Детальное описание элементов

**`<osmp_txn_id>`:**
- Обязательный элемент
- Содержит значение параметра `txn_id` из запроса
- Используется для сопоставления запроса и ответа
- Формат: целое число длиной до 20 знаков

**`<prv_txn>`:**
- **Обязателен** для запроса типа `pay` (пополнение баланса)
- **Не обрабатывается** для запроса типа `check` (может быть пустым или отсутствовать)
- Уникальный номер операции пополнения баланса в базе поставщика
- Формат: целое число длиной до 20 знаков
- Должен быть уникальным в рамках базы поставщика
- Используется для идентификации операции при сверке

**`<sum>`:**
- Обязательный элемент
- Сумма платежа в формате `XXX.XX` (дробное число с точностью до сотых)
- Разделитель дробной части: точка (.)
- Должна совпадать с суммой из запроса

**`<result>`:**
- Обязательный элемент
- Код результата завершения запроса
- Значение `0` означает успешное завершение операции
- Все остальные значения означают ошибку (см. [Приложение А](#приложение-а-таблица-кодов-ошибок))

**`<comment>`:**
- Необязательный элемент
- Может быть пустым: `<comment></comment>` или `<comment/>`
- Содержит служебный комментарий или описание ошибки
- Рекомендуется заполнять для облегчения диагностики проблем
- Максимальная длина: 255 символов

### 3.4. Требования к валидности XML

- XML-документ должен быть **валидным** и **well-formed**
- Обязательное наличие XML-декларации: `<?xml version="1.0" encoding="UTF-8"?>`
- Все открывающие теги должны иметь соответствующие закрывающие теги
- Специальные символы должны быть экранированы:
  - `<` → `&lt;`
  - `>` → `&gt;`
  - `&` → `&amp;`
  - `"` → `&quot;`
  - `'` → `&apos;`
- Некорректный XML считается **фатальной ошибкой** и обрабатывается системой как код ошибки **300**

---

## 4. ОПИСАНИЕ ПРОТОКОЛА

### 4.1. Общие принципы работы

Протокол взаимодействия построен на принципе **запрос-ответ** и состоит из двух этапов:

1. **Проверка состояния счета** (`check`) — валидация возможности проведения платежа
2. **Пополнение баланса** (`pay`) — непосредственное зачисление средств на счет абонента

**Последовательность операций:**
1. Система отправляет запрос `check` для проверки возможности проведения платежа
2. Поставщик возвращает результат проверки
3. При успешной проверке (`result=0`) система отправляет запрос `pay` для пополнения баланса
4. Поставщик возвращает результат пополнения баланса
5. При успешном пополнении (`result=0`) транзакция считается завершенной

**Важно:** Система **не будет** отправлять запрос `pay`, если запрос `check` завершился ошибкой (код ошибки ≠ 0).

### 4.2. Запрос на проверку состояния счета (`check`)

#### 4.2.1. Назначение

Запрос `check` предназначен для:
- Проверки наличия абонента с указанным идентификатором в базе поставщика
- Валидации формата идентификатора абонента
- Проверки возможности приема платежа на указанную сумму
- Проверки статуса счета абонента (активен/неактивен)
- Внутренних проверок поставщика в соответствии с принятой логикой пополнения лицевых счетов

#### 4.2.2. Параметры запроса

| Параметр | Обязательность | Описание |
|----------|----------------|----------|
| `command` | Обязательный | Значение: `check` |
| `txn_id` | Обязательный | Уникальный идентификатор транзакции |
| `account` | Обязательный | Идентификатор абонента |
| `sum` | Обязательный | Сумма платежа |

**Примечание:** Параметр `txn_date` **не передается** в запросе `check`.

#### 4.2.3. Пример запроса

```
https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567890&account=4957835959&sum=10.45
```

#### 4.2.4. Пример успешного ответа

```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>10.45</sum>
    <result>0</result>
    <comment></comment>
</response>
```

**Примечание:** Элемент `<prv_txn>` в ответе на запрос `check` **не обрабатывается** и может отсутствовать.

#### 4.2.5. Интерпретация результата

- **`result=0`** — проверка пройдена успешно, лицевой счет абонента может быть пополнен на указанную сумму. Система переходит к отправке запроса `pay`.
- **`result≠0`** — проверка не пройдена, операция завершается с ошибкой. Система **не отправляет** запрос `pay`.

### 4.3. Запрос на пополнение лицевого счета (`pay`)

#### 4.3.1. Назначение

Запрос `pay` предназначен для:
- Непосредственного пополнения баланса счета абонента
- Регистрации транзакции в базе поставщика
- Возврата уникального номера операции пополнения (`prv_txn`)

**Важно:** Запрос `pay` отправляется системой **только после** успешного завершения запроса `check` (`result=0`).

#### 4.3.2. Параметры запроса

| Параметр | Обязательность | Описание |
|----------|----------------|----------|
| `command` | Обязательный | Значение: `pay` |
| `txn_id` | Обязательный | Уникальный идентификатор транзакции (должен совпадать с `txn_id` из запроса `check`) |
| `txn_date` | Обязательный | Дата и время платежа в формате `YYYYMMDDHHmmss` |
| `account` | Обязательный | Идентификатор абонента (должен совпадать с `account` из запроса `check`) |
| `sum` | Обязательный | Сумма платежа (должна совпадать с `sum` из запроса `check`) |

#### 4.3.3. Пример запроса

```
https://service.provider.ru:8443/payment_app.cgi?command=pay&txn_id=12345678901234567890&txn_date=20090815120133&account=4957835959&sum=10.45
```

#### 4.3.4. Пример успешного ответа

```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>2016</prv_txn>
    <sum>10.45</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Примечание:** Элемент `<prv_txn>` в ответе на запрос `pay` **обязателен** и должен содержать уникальный номер операции пополнения в базе поставщика.

#### 4.3.5. Интерпретация результата

- **`result=0`** — пополнение баланса выполнено успешно, транзакция завершена.
- **`result≠0`** — пополнение баланса не выполнено, операция завершена с ошибкой.

#### 4.3.6. Требования к обработке запроса `pay`

1. **Идемпотентность:**
   - Если запрос с данным `txn_id` уже был обработан успешно, поставщик **обязан** вернуть результат предыдущей обработки без повторного пополнения баланса.
   - Элемент `<prv_txn>` должен содержать номер операции из предыдущей успешной обработки.

2. **Атомарность:**
   - Операция пополнения баланса должна быть атомарной (все или ничего).
   - В случае ошибки баланс абонента не должен изменяться.

3. **Транзакционность:**
   - Рекомендуется использование транзакций базы данных для обеспечения целостности данных.

---

## 5. ТРЕБОВАНИЯ К ОБРАБОТКЕ ОШИБОК

### 5.1. Классификация ошибок

Все ошибки классифицируются на два типа:

1. **Фатальные ошибки** — ошибки, при которых повторная отправка запроса с теми же параметрами приведет к 100% повторению той же ошибки.
2. **Нефатальные ошибки** — ошибки, при которых повторение запроса через некоторый промежуток времени может привести к успеху.

### 5.2. Поведение системы при ошибках

**Фатальные ошибки:**
- Система **прекращает** обработку клиентского запроса
- Система **не выполняет** повторные попытки
- Клиент получает ошибку немедленно

**Нефатальные ошибки:**
- Система **повторяет** запрос с увеличивающимся интервалом (exponential backoff)
- Максимальное время жизни запроса: **24 часа**
- Система прекращает повторные попытки при:
  - Успешном завершении операции
  - Получении фатальной ошибки
  - Истечении срока жизни запроса (24 часа)

### 5.3. Специальные случаи

**Отсутствие связи с сервером поставщика:**
- Классификация: **нефатальная ошибка**
- Система будет повторять запрос с увеличивающимся интервалом

**Некорректный XML-ответ:**
- Отсутствие элемента `<result>` в ответе
- Некорректный формат XML
- Страница "Service temporarily unavailable" или аналогичные
- Классификация: **фатальная ошибка**
- Система обрабатывает это как код ошибки **300** (Другая ошибка поставщика)

**HTTP-ошибки:**
- `4xx` (кроме 429) — фатальная ошибка, код **300**
- `429 Too Many Requests` — нефатальная ошибка, код **1**
- `5xx` — нефатальная ошибка, код **1**

### 5.4. Таблица кодов ошибок

Полный список кодов ошибок и их классификация приведены в [Приложении А](#приложение-а-таблица-кодов-ошибок).

### 5.5. Требования к обработке ошибок поставщиком

1. **Всегда возвращать валидный XML:**
   - Даже при критических ошибках поставщик **обязан** вернуть валидный XML-ответ с корректным элементом `<result>`.

2. **Корректный код ошибки:**
   - Код ошибки должен соответствовать таблице кодов (см. [Приложение А](#приложение-а-таблица-кодов-ошибок)).
   - Не использовать произвольные коды ошибок.

3. **Информативный комментарий:**
   - Рекомендуется заполнять элемент `<comment>` описанием ошибки для облегчения диагностики.

4. **Логирование ошибок:**
   - Все ошибки должны логироваться с полным контекстом запроса.

---

## 6. ТАЙМ-АУТЫ И RETRY-ЛОГИКА

### 6.1. Тайм-ауты системы

**Тайм-аут соединения:**
- Максимальное время ожидания ответа: **60 секунд**
- При превышении тайм-аута система разрывает соединение
- Классификация: **нефатальная ошибка** (код **1**)

**Рекомендации для поставщика:**
- Время ответа на запрос `check`: **не более 5 секунд**
- Время ответа на запрос `pay`: **не более 10 секунд**
- Оптимальное время ответа: **1-2 секунды**

### 6.2. Retry-логика системы

**Параметры retry:**
- Начальный интервал: **1 секунда**
- Максимальный интервал: **3600 секунд (1 час)**
- Стратегия: **exponential backoff** (экспоненциальное увеличение интервала)
- Максимальное время жизни запроса: **24 часа**

**Формула интервала:**
```
interval = min(initial_interval * (2 ^ attempt_number), max_interval)
```

**Пример интервалов:**
- Попытка 1: 1 секунда
- Попытка 2: 2 секунды
- Попытка 3: 4 секунды
- Попытка 4: 8 секунд
- Попытка 5: 16 секунд
- ...
- Попытка 12: 3600 секунд (максимум)

### 6.3. Рекомендации для поставщика

**Обработка повторных запросов:**
- Поставщик должен корректно обрабатывать повторные запросы с теми же параметрами (идемпотентность).
- Для запросов `pay` поставщик должен проверять наличие транзакции с данным `txn_id` и возвращать результат предыдущей обработки.

**Оптимизация производительности:**
- Использовать кэширование для запросов `check` (если применимо).
- Оптимизировать запросы к базе данных.
- Использовать connection pooling.
- Мониторить время ответа и выявлять узкие места.

**Graceful degradation:**
- При высокой нагрузке поставщик может возвращать код ошибки **1** (Временная ошибка) с комментарием о перегрузке.
- Система автоматически повторит запрос через некоторое время.

---

## 7. ЕЖЕДНЕВНАЯ СВЕРКА

### 7.1. Назначение сверки

Ежедневная сверка предназначена для:
- Сверки успешно проведенных платежей между системой и поставщиком
- Выявления расхождений в данных
- Решения спорных вопросов
- Подтверждения корректности взаиморасчетов

### 7.2. Формат и время отправки

**Время отправки:**
- Реестр отправляется **до 10:00 по московскому времени (MSK, UTC+3)**
- Реестр содержит платежи за **предыдущий календарный день** (с 00:00:00 до 23:59:59)

**Способ доставки:**
- Электронная почта (email)
- Адрес получателя указывается в договоре или настраивается в личном кабинете поставщика

**Формат файла:**
- Текстовый файл в кодировке UTF-8
- Разделитель полей: **знак табуляции (TAB)**
- Разделитель строк: `\r\n` (CRLF) или `\n` (LF)
- Дробная часть суммы отделена **точкой (.)**

### 7.3. Структура реестра

**Заголовок:**
```
<email адрес получателя>
```

**Тело реестра:**
```
<txn_id>	<дата>	<время>	<идентификатор абонента>	<сумма>
...
<txn_id>	<дата>	<время>	<идентификатор абонента>	<сумма>
Total: <количество платежей>	<общая сумма>
```

**Описание полей:**
- `txn_id` — уникальный идентификатор транзакции в системе
- `дата` — дата платежа в формате `DD.MM.YYYY` (московское время)
- `время` — время платежа в формате `HH:MM:SS` (московское время)
- `идентификатор абонента` — значение параметра `account` из запроса
- `сумма` — сумма платежа в формате `XXX.XX`

**Итоговая строка:**
- Формат: `Total: <количество>	<общая сумма>`
- Содержит общее количество платежей и общую сумму всех платежей

### 7.4. Пример реестра

```
reconciliation@provider.ru
11111111	31.01.2009	12:13:14	4957835959	123.45
11111112	31.01.2009	13:22:34	8002000059	0.01
11111113	31.01.2009	14:55:11	9161111111	123.01
11111114	31.01.2009	14:55:12	1234567890	1000.00
Total: 4	1246.47
```

### 7.5. Правила включения в реестр

**Включаются в реестр:**
- Только успешно проведенные платежи (запрос `pay` с `result=0`)
- Платежи, которые были подтверждены как при online обмене сообщениями, так и в реестре

**Не включаются в реестр:**
- Платежи, завершившиеся ошибкой
- Платежи, для которых не был отправлен запрос `pay` (ошибка на этапе `check`)

### 7.6. Процедура сверки

**Обязанности поставщика:**
1. Ежедневно получать и обрабатывать реестр до **12:00 по московскому времени**
2. Сверять платежи из реестра с платежами в собственной базе данных
3. Выявлять расхождения:
   - Платежи в реестре, отсутствующие в базе поставщика
   - Платежи в базе поставщика, отсутствующие в реестре
4. При обнаружении расхождений **немедленно** связаться с контактным лицом в системе (указано в договоре) **до 12:00**
5. Сохранять реестры для архивных целей (минимум 1 год)

**Обязанности системы:**
1. Отправлять реестр ежедневно до 10:00
2. Обеспечивать доставку реестра на указанный email-адрес
3. Рассматривать обращения поставщика о расхождениях в течение 24 часов

### 7.7. Обработка расхождений

**Типы расхождений:**
1. **Платеж в реестре отсутствует в базе поставщика:**
   - Возможные причины: ошибка при обработке запроса `pay`, потеря данных
   - Действие: проверка логов, восстановление транзакции при необходимости

2. **Платеж в базе поставщика отсутствует в реестре:**
   - Возможные причины: ошибка на стороне системы, транзакция не была подтверждена
   - Действие: проверка статуса транзакции в системе

3. **Неполучение реестра:**
   - Действие: немедленное обращение к контактному лицу в системе

**Важно:** Все расхождения должны быть разрешены в течение **3 рабочих дней** с момента обнаружения.

---

## ПРИЛОЖЕНИЕ А: ТАБЛИЦА КОДОВ ОШИБОК

При обработке запросов от системы поставщик должен сопоставить все возникающие в его приложении ошибки с приведенным ниже списком и возвращать соответствующие коды в элементе `<result>`.

| Код | Комментарий | Фатальность | Описание |
|-----|-------------|-------------|----------|
| **0** | ОК | — | Операция выполнена успешно |
| **1** | Временная ошибка. Повторите запрос позже | Нет | Временная ошибка на стороне поставщика (перегрузка, недоступность сервиса, тайм-аут базы данных). Система будет повторять запрос с увеличивающимся интервалом |
| **4** | Неверный формат идентификатора абонента | Да | Идентификатор абонента не соответствует формату, указанному поставщиком (не проходит регулярное выражение) |
| **5** | Идентификатор абонента не найден (Ошиблись номером) | Да | Абонент с указанным идентификатором не существует в базе поставщика |
| **7** | Прием платежа запрещен поставщиком | Да | Прием платежей для данного абонента или операции запрещен поставщиком (блокировка счета, технические ограничения) |
| **79** | Счет абонента не активен | Да | Счет абонента существует, но не активен (приостановлен, заблокирован, закрыт) |
| **90** | Проведение платежа не окончено | Нет | Платеж находится в процессе обработки. Система будет повторять запрос для проверки статуса |
| **241** | Сумма слишком мала | Да | Сумма платежа меньше минимально допустимой суммы, установленной поставщиком |
| **242** | Сумма слишком велика | Да | Сумма платежа больше максимально допустимой суммы, установленной поставщиком |
| **243** | Невозможно проверить состояние счета | Да | Внутренняя ошибка поставщика при проверке состояния счета (недоступность базы данных, ошибка валидации) |
| **300** | Другая ошибка поставщика | Да | Любая другая ошибка, не описанная в данной таблице. Используется для ошибок, которые не могут быть классифицированы другими кодами |

### Рекомендации по использованию кодов ошибок

1. **Код 0 (ОК):**
   - Использовать только при успешном завершении операции
   - Для запроса `check`: проверка пройдена, можно выполнять `pay`
   - Для запроса `pay`: баланс пополнен успешно

2. **Код 1 (Временная ошибка):**
   - Использовать для всех временных проблем (перегрузка, недоступность сервиса, тайм-ауты)
   - **Не использовать** для ошибок валидации или бизнес-логики

3. **Коды 4, 5, 7, 79 (Ошибки валидации и бизнес-логики):**
   - Всегда фатальные
   - Система не будет повторять запрос
   - Клиент получит ошибку немедленно

4. **Код 90 (Проведение платежа не окончено):**
   - Использовать только для запросов `pay`
   - Указывает, что платеж обрабатывается асинхронно
   - Система будет повторять запрос для проверки статуса

5. **Коды 241, 242 (Ограничения по сумме):**
   - Минимальная и максимальная суммы должны быть указаны в договоре
   - Рекомендуется возвращать в комментарии допустимый диапазон сумм

6. **Код 300 (Другая ошибка):**
   - Использовать только если ошибка не может быть классифицирована другими кодами
   - Рекомендуется указывать детальное описание ошибки в элементе `<comment>`

---

## ПРИЛОЖЕНИЕ Б: РЕГУЛЯРНОЕ ВЫРАЖЕНИЕ ДЛЯ ИДЕНТИФИКАТОРА АБОНЕНТА

### Общие требования

Идентификатор абонента (`account`) должен соответствовать регулярному выражению, предоставленному поставщиком услуг.

### Стандартное регулярное выражение

Если поставщик не предоставил специфическое регулярное выражение, используется следующее стандартное:

**Регулярное выражение:**
```
^[a-zA-Z0-9а-яА-ЯёЁ\-_\.]{1,50}$
```

**Описание:**
- `^` — начало строки
- `[a-zA-Z0-9а-яА-ЯёЁ\-_\.]` — допустимые символы:
  - Латинские буквы (a-z, A-Z)
  - Цифры (0-9)
  - Кириллические буквы (а-я, А-Я, ё, Ё)
  - Дефис (-)
  - Подчеркивание (_)
  - Точка (.)
- `{1,50}` — длина от 1 до 50 символов
- `$` — конец строки

### Примеры валидных идентификаторов

- `4957835959` (телефон)
- `user123` (логин)
- `account-001` (номер счета)
- `test.user@domain` (email-подобный идентификатор)
- `абонент123` (кириллица)

### Примеры невалидных идентификаторов

- `` (пустая строка)
- `account with spaces` (пробелы не допускаются)
- `account@domain.com` (символ @ не допускается в стандартном выражении)
- `account#123` (символ # не допускается)

### Предоставление специфического регулярного выражения

Поставщик **обязан** предоставить регулярное выражение для валидации идентификатора абонента при подключении к системе.

**Требования к регулярному выражению:**
- Должно быть валидным PCRE (Perl Compatible Regular Expressions)
- Должно быть предоставлено в текстовом виде
- Рекомендуется предоставить примеры валидных и невалидных идентификаторов

**Пример специфического регулярного выражения для телефонных номеров:**
```
^[0-9]{10,11}$
```

**Пример специфического регулярного выражения для email:**
```
^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$
```

---

## ПРИЛОЖЕНИЕ В: ОПИСАНИЕ СЕТЕВОЙ ПОДСЕТИ

### Параметры подсети

**Подсеть:** `79.142.16.0/20`

**Маска подсети:** `255.255.240.0` (20 бит)

**CIDR-нотация:** `/20`

### Диапазон IP-адресов

**Начальный IP:** `79.142.16.0`  
**Конечный IP:** `79.142.31.255`  
**Количество адресов:** `4096` (2^12)

### Детальное описание

Подсеть `79.142.16.0/20` включает следующие IP-адреса:

- `79.142.16.0` — сетевой адрес (не используется для хостов)
- `79.142.16.1` — первый используемый адрес
- `79.142.31.254` — последний используемый адрес
- `79.142.31.255` — broadcast-адрес (не используется для хостов)

**Используемый диапазон для хостов:** `79.142.16.1` — `79.142.31.254`

### Настройка IP-фильтрации

**На уровне веб-сервера (Nginx):**
```nginx
location /payment_app.cgi {
    allow 79.142.16.0/20;
    deny all;
    # ... остальная конфигурация
}
```

**На уровне веб-сервера (Apache):**
```apache
<Location /payment_app.cgi>
    Require ip 79.142.16.0/20
</Location>
```

**На уровне приложения (.NET):**
```csharp
// Пример middleware для проверки IP
public class IpWhitelistMiddleware
{
    private readonly RequestDelegate _next;
    private readonly string _allowedSubnet = "79.142.16.0/20";

    public async Task InvokeAsync(HttpContext context)
    {
        var remoteIp = context.Connection.RemoteIpAddress;
        if (!IsIpInSubnet(remoteIp, _allowedSubnet))
        {
            context.Response.StatusCode = 403;
            await context.Response.WriteAsync("Forbidden");
            return;
        }
        await _next(context);
    }
}
```

**На уровне firewall (iptables):**
```bash
iptables -A INPUT -p tcp --dport 443 -s 79.142.16.0/20 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j DROP
```

### Проверка принадлежности IP-адреса к подсети

**Функция проверки (C#):**
```csharp
public static bool IsIpInSubnet(IPAddress ip, string subnet)
{
    var parts = subnet.Split('/');
    var subnetIp = IPAddress.Parse(parts[0]);
    var prefixLength = int.Parse(parts[1]);
    
    var ipBytes = ip.GetAddressBytes();
    var subnetBytes = subnetIp.GetAddressBytes();
    
    if (ipBytes.Length != subnetBytes.Length)
        return false;
    
    var bytesToCheck = prefixLength / 8;
    var bitsToCheck = prefixLength % 8;
    
    for (int i = 0; i < bytesToCheck; i++)
    {
        if (ipBytes[i] != subnetBytes[i])
            return false;
    }
    
    if (bitsToCheck > 0)
    {
        var mask = (byte)(0xFF << (8 - bitsToCheck));
        if ((ipBytes[bytesToCheck] & mask) != (subnetBytes[bytesToCheck] & mask))
            return false;
    }
    
    return true;
}
```

### Важные замечания

1. **Безопасность:**
   - IP-фильтрация является **обязательным** требованием безопасности
   - Запросы с неразрешенных IP-адресов должны отклоняться **до** обработки запроса приложением

2. **Тестирование:**
   - Для тестовых сред может быть разрешен доступ с других IP-адресов
   - В production-среде доступ должен быть ограничен **только** указанной подсетью

3. **Мониторинг:**
   - Рекомендуется логировать все попытки доступа с неразрешенных IP-адресов
   - Подозрительная активность должна отслеживаться и расследоваться

---

## ПРИЛОЖЕНИЕ Г: ПРИМЕРЫ ЗАПРОСОВ И ОТВЕТОВ

### Пример 1: Успешная проверка счета (check)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567890&account=4957835959&sum=10.45 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>10.45</sum>
    <result>0</result>
    <comment></comment>
</response>
```

**HTTP-заголовки ответа:**
```
HTTP/1.1 200 OK
Content-Type: application/xml; charset=utf-8
Content-Length: 156
```

---

### Пример 2: Успешное пополнение баланса (pay)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=pay&txn_id=12345678901234567890&txn_date=20090815120133&account=4957835959&sum=10.45 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>2016</prv_txn>
    <sum>10.45</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**HTTP-заголовки ответа:**
```
HTTP/1.1 200 OK
Content-Type: application/xml; charset=utf-8
Content-Length: 185
```

---

### Пример 3: Ошибка — абонент не найден (check)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567891&account=9999999999&sum=10.45 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567891</osmp_txn_id>
    <sum>10.45</sum>
    <result>5</result>
    <comment>Идентификатор абонента не найден в базе данных</comment>
</response>
```

---

### Пример 4: Ошибка — неверный формат идентификатора (check)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567892&account=invalid@account#123&sum=10.45 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567892</osmp_txn_id>
    <sum>10.45</sum>
    <result>4</result>
    <comment>Идентификатор абонента не соответствует требуемому формату. Ожидается формат: ^[0-9]{10,11}$</comment>
</response>
```

---

### Пример 5: Ошибка — сумма слишком мала (check)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567893&account=4957835959&sum=0.01 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567893</osmp_txn_id>
    <sum>0.01</sum>
    <result>241</result>
    <comment>Минимальная сумма платежа: 10.00 рублей</comment>
</response>
```

---

### Пример 6: Ошибка — счет не активен (check)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567894&account=4957835959&sum=100.00 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567894</osmp_txn_id>
    <sum>100.00</sum>
    <result>79</result>
    <comment>Счет абонента приостановлен. Обратитесь в службу поддержки</comment>
</response>
```

---

### Пример 7: Временная ошибка (check)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=check&txn_id=12345678901234567895&account=4957835959&sum=100.00 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567895</osmp_txn_id>
    <sum>100.00</sum>
    <result>1</result>
    <comment>Временная недоступность сервиса. Повторите запрос через несколько секунд</comment>
</response>
```

---

### Пример 8: Повторный запрос с существующим txn_id (pay) — идемпотентность

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=pay&txn_id=12345678901234567890&txn_date=20090815120133&account=4957835959&sum=10.45 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ (возвращается результат предыдущей обработки):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>2016</prv_txn>
    <sum>10.45</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Примечание:** Поставщик не выполняет повторное пополнение баланса, а возвращает результат предыдущей успешной обработки.

---

### Пример 9: Ошибка — проведение платежа не окончено (pay)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=pay&txn_id=12345678901234567896&txn_date=20090815120133&account=4957835959&sum=100.00 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567896</osmp_txn_id>
    <sum>100.00</sum>
    <result>90</result>
    <comment>Платеж находится в процессе обработки. Повторите запрос через несколько секунд</comment>
</response>
```

**Примечание:** Система будет повторять запрос для проверки статуса платежа.

---

### Пример 10: Ошибка — другая ошибка поставщика (pay)

**Запрос:**
```
GET https://service.provider.ru:8443/payment_app.cgi?command=pay&txn_id=12345678901234567897&txn_date=20090815120133&account=4957835959&sum=100.00 HTTP/1.1
Host: service.provider.ru:8443
User-Agent: YessBackend/1.0
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567897</osmp_txn_id>
    <sum>100.00</sum>
    <result>300</result>
    <comment>Внутренняя ошибка базы данных: Connection timeout. Обратитесь в техническую поддержку</comment>
</response>
```

---

## ЗАКЛЮЧЕНИЕ

Данный документ описывает технический интерфейс подключения поставщиков услуг версии 2.0. При реализации интерфейса поставщик обязан соблюдать все требования, изложенные в данном документе.

**Контактная информация:**
- Техническая поддержка: указана в договоре
- Email для вопросов: указан в договоре
- Документация: актуальная версия всегда доступна в личном кабинете поставщика

**Версионирование:**
- Текущая версия документа: **2.0**
- Дата последнего обновления: **2024**
- История изменений доступна в репозитории документации

**Поддержка:**
- Все вопросы по интеграции следует направлять в техническую поддержку
- Рекомендуется тестирование интерфейса в тестовой среде перед запуском в production

---

**Конец документа**

