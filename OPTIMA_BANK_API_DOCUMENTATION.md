# Документация API для Optima Bank

## Общая информация

Данный документ описывает интеграцию платежной системы YESS Loyalty с Optima Bank. Backend реализует протокол QIWI OSMP версии 1.4 для приема платежей от банка.

**Версия API:** v1  
**Протокол:** QIWI OSMP v1.4  
**Формат ответов:** XML (UTF-8)  
**Метод запросов:** GET

---

## Базовый URL

**Production:**
- HTTP: `http://api.yessgo.org/api/v1/optima/payment`
- HTTPS: `https://api.yessgo.org/api/v1/optima/payment`

**Важно:** Система принимает запросы только с IP-адресов, указанных в конфигурации. По умолчанию разрешены запросы из подсети Optima Bank.

---

## Безопасность

### Проверка IP-адресов

Система проверяет IP-адрес отправителя запроса. Разрешенные подсети настраиваются в конфигурации:

```json
{
  "OptimaPayment": {
    "IpCheckEnabled": true,
    "AllowedIpRanges": [
      "79.142.16.0/20",
      "31.148.30.4/32",
      "185.117.148.111/32"
    ]
  }
}
```

**Подсеть Optima Bank:** `79.142.16.0/20` (диапазон: `79.142.16.0` — `79.142.31.255`)

Если запрос приходит с неразрешенного IP-адреса, система возвращает ошибку:
- HTTP Status: `403 Forbidden`
- XML Response: `result=300` (Другая ошибка поставщика)

---

## API Endpoints

### Проверка счета (CHECK)

Проверяет возможность пополнения счета пользователя.

**Endpoint:** `/api/v1/optima/payment`

**Параметры запроса:**

| Параметр | Обязательный | Тип | Формат | Описание |
|----------|--------------|-----|--------|----------|
| `command` | Да | string | `check` | Тип команды |
| `txn_id` | Да | string | До 20 цифр | Уникальный идентификатор транзакции (QID) |
| `account` | Да | string | 1-10 цифр | ID пользователя в системе YESS |
| `sum` | Да | string | `XX.XX` | Сумма платежа (обязательно 2 знака после точки) |

**Пример запроса:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=15&sum=100.00
```

**Пример успешного ответа:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>100.00</sum>
  <result>0</result>
  <comment>OK</comment>
</response>
```

**Пример ответа при ошибке (пользователь не найден):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>100.00</sum>
  <result>5</result>
  <comment>Пользователь не найден</comment>
</response>
```

---

### Пополнение баланса (PAY)

Выполняет пополнение баланса пользователя.

**Endpoint:** `/api/v1/optima/payment`

**Параметры запроса:**

| Параметр | Обязательный | Тип | Формат | Описание |
|----------|--------------|-----|--------|----------|
| `command` | Да | string | `pay` | Тип команды |
| `txn_id` | Да | string | До 20 цифр | Уникальный идентификатор транзакции (QID) |
| `account` | Да | string | 1-10 цифр | ID пользователя в системе YESS |
| `sum` | Да | string | `XX.XX` | Сумма платежа (обязательно 2 знака после точки) |
| `txn_date` | Нет | string | `yyyyMMddHHmmss` | Дата и время транзакции (если не указана - используется текущее время) |

**Пример запроса:**
```
GET /api/v1/optima/payment?command=pay&txn_id=12345678901234567890&account=15&sum=100.00&txn_date=20241125143000
```

**Пример успешного ответа:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <prv_txn>12345</prv_txn>
  <sum>100.00</sum>
  <result>0</result>
  <comment>OK</comment>
</response>
```

**Примечание:** Элемент `prv_txn` содержит внутренний ID транзакции в системе YESS и возвращается только при успешном выполнении команды `pay`.

---

## Коды результата (result)

Система возвращает следующие коды результата согласно протоколу QIWI OSMP v1.4:

| Код | Описание | Тип ошибки | Описание |
|-----|----------|------------|----------|
| `0` | OK | Успех | Операция выполнена успешно |
| `1` | Временная ошибка | Нефатальная | Временная ошибка. Повторите запрос позже |
| `4` | Неверный формат идентификатора | Фатальная | Неверный формат идентификатора абонента |
| `5` | Идентификатор не найден | Фатальная | Идентификатор абонента не найден (Ошиблись номером) |
| `7` | Прием платежа запрещен | Фатальная | Прием платежа запрещен поставщиком |
| `79` | Счет не активен | Фатальная | Счет абонента не активен |
| `90` | Проведение платежа не окончено | Нефатальная | Проведение платежа не окончено |
| `241` | Сумма слишком мала | Фатальная | Сумма слишком мала (минимум: 1.00) |
| `242` | Сумма слишком велика | Фатальная | Сумма слишком велика (максимум: 100000.00) |
| `243` | Невозможно проверить состояние счета | Фатальная | Невозможно проверить состояние счета |
| `300` | Другая ошибка поставщика | Фатальная | Другая ошибка поставщика |

**Типы ошибок:**
- **Фатальная ошибка:** Повторная отправка запроса с теми же параметрами приведет к той же ошибке. Обработка должна быть прекращена.
- **Нефатальная ошибка:** Система может повторить запрос позже.

---

## Валидация параметров

### txn_id
- **Формат:** Только цифры
- **Длина:** До 20 символов
- **Пример:** `12345678901234567890`

### account
- **Формат:** Только цифры
- **Длина:** От 1 до 10 символов
- **Пример:** `15`, `12345`
- **Валидация:** Должен быть положительным целым числом

### sum
- **Формат:** Десятичное число с точностью до сотых
- **Разделитель:** Точка (`.`)
- **Обязательно:** Два знака после точки
- **Примеры:** `1.00`, `100.50`, `1000.00`
- **Диапазон:** От `1.00` до `100000.00`

### txn_date (опционально)
- **Формат:** `yyyyMMddHHmmss`
- **Пример:** `20241125143000` (25 ноября 2024, 14:30:00)
- **Если не указана:** Используется текущее время сервера

---

## Идемпотентность

Система гарантирует идемпотентность операций `pay`. Если запрос с одинаковым `txn_id` уже был успешно обработан, система возвращает предыдущий успешный результат без повторного пополнения баланса.

**Пример:**
1. Первый запрос: `txn_id=12345678901234567890` → баланс пополнен, возвращен `prv_txn=12345`
2. Повторный запрос: `txn_id=12345678901234567890` → баланс НЕ пополняется повторно, возвращается тот же `prv_txn=12345`

---

## Логирование и аудит

Все запросы от Optima Bank логируются в системе со следующей информацией:
- IP-адрес отправителя
- User-Agent
- Параметры запроса (command, txn_id, account, sum, txn_date)
- Результат обработки (код результата, комментарий)
- Время обработки

Все транзакции сохраняются в таблице `PaymentProviderTransactions` для последующей сверки.

---

## Сверка платежей

Система автоматически генерирует ежедневные реестры сверки платежей согласно требованиям QIWI OSMP v1.4.

### Формат реестра

Реестр формируется в текстовом формате (TAB-разделенные значения, UTF-8):

```
reconciliation@yess-loyalty.com

12345678901234567890	25.11.2024	14:30:00	15	100.00
12345678901234567891	25.11.2024	15:45:00	16	250.50
Total:	2	350.50
```

**Структура:**
1. Первая строка: Email адрес получателя
2. Пустая строка
3. Строки с данными платежей (разделитель: TAB):
   - `txn_id` - идентификатор транзакции
   - `дата` - дата в формате `dd.MM.yyyy`
   - `время` - время в формате `HH:mm:ss`
   - `account` - идентификатор пользователя
   - `сумма` - сумма платежа с двумя знаками после точки
4. Итоговая строка: `Total: <количество> <общая сумма>`

### Автоматическая генерация

Реестры генерируются автоматически каждый день за предыдущий день и отправляются на email адрес, указанный в конфигурации:
- Email: `reconciliation@yess-loyalty.com` (настраивается в `OptimaPayment:ReconciliationEmail`)

### Ручная генерация (Admin API)

Администраторы могут вручную сгенерировать и отправить реестр через Admin API:

**Endpoint:** `/api/v1/admin/optima/reconciliation`

**Методы:**
- `POST /generate?date=2024-11-25` - Генерация реестра за указанную дату
- `POST /{reportId}/send?email=example@bank.kg` - Отправка реестра на email
- `POST /generate-and-send?date=2024-11-25&email=example@bank.kg` - Генерация и отправка
- `GET /` - Получение списка реестров
- `GET /{reportId}` - Получение реестра по ID

**Требуется авторизация:** Да (JWT токен администратора)

---

## Конфигурация

Настройки интеграции находятся в файле `appsettings.json`:

```json
{
  "OptimaPayment": {
    "Enabled": true,
    "MinAmount": 1.0,
    "MaxAmount": 100000.0,
    "IpCheckEnabled": true,
    "AllowedIpRanges": [
      "79.142.16.0/20",
      "31.148.30.4/32",
      "185.117.148.111/32"
    ],
    "ReconciliationEmail": "reconciliation@yess-loyalty.com"
  }
}
```

**Параметры:**
- `Enabled` - Включен ли прием платежей от Optima Bank
- `MinAmount` - Минимальная сумма платежа (по умолчанию: 1.00)
- `MaxAmount` - Максимальная сумма платежа (по умолчанию: 100000.00)
- `IpCheckEnabled` - Включена ли проверка IP-адресов
- `AllowedIpRanges` - Список разрешенных подсетей в формате CIDR
- `ReconciliationEmail` - Email адрес для отправки реестров сверки

---

## Примеры использования

### Пример 1: Проверка существующего пользователя

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=15&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567890</osmp_txn_id>
  <sum>100.00</sum>
  <result>0</result>
  <comment>OK</comment>
</response>
```

### Пример 2: Пополнение баланса

**Запрос:**
```
GET /api/v1/optima/payment?command=pay&txn_id=12345678901234567891&account=15&sum=100.00&txn_date=20241125143000
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567891</osmp_txn_id>
  <prv_txn>12345</prv_txn>
  <sum>100.00</sum>
  <result>0</result>
  <comment>OK</comment>
</response>
```

### Пример 3: Ошибка - пользователь не найден

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567892&account=99999&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567892</osmp_txn_id>
  <sum>100.00</sum>
  <result>5</result>
  <comment>Пользователь не найден</comment>
</response>
```

### Пример 4: Ошибка - сумма слишком мала

**Запрос:**
```
GET /api/v1/optima/payment?command=pay&txn_id=12345678901234567893&account=15&sum=0.50
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567893</osmp_txn_id>
  <sum>0.50</sum>
  <result>241</result>
  <comment>Минимальная сумма пополнения: 1.00</comment>
</response>
```

### Пример 5: Ошибка - неверный формат суммы

**Запрос:**
```
GET /api/v1/optima/payment?command=pay&txn_id=12345678901234567894&account=15&sum=100
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <osmp_txn_id>12345678901234567894</osmp_txn_id>
  <sum>0</sum>
  <result>300</result>
  <comment>Неверный формат суммы (требуется формат: 10.45)</comment>
</response>
```

---

## Тестирование

### Тестовые пользователи

Для тестирования интеграции можно использовать следующие тестовые пользователи (если они созданы в системе):

- **Account ID: 15** - Активный пользователь для успешных операций
- **Account ID: 16** - Активный пользователь для тестирования различных сумм
- **Account ID: 99999** - Не существует (для тестирования ошибки "Пользователь не найден")

### cURL примеры

**Проверка счета:**
```bash
curl -k "https://api.yessgo.org/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=15&sum=100.00"
```

**Пополнение баланса:**
```bash
curl -k "https://api.yessgo.org/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20241125143000&account=15&sum=100.00"
```

**Примечание:** Флаг `-k` используется для игнорирования проверки SSL сертификата (только для тестирования).

---

## Обработка ошибок

### HTTP статусы

- `200 OK` - Запрос обработан (даже при ошибке в бизнес-логике)
- `400 Bad Request` - Некорректный запрос (неверный формат параметров)
- `403 Forbidden` - Доступ запрещен (IP-адрес не в whitelist)
- `500 Internal Server Error` - Внутренняя ошибка сервера

**Важно:** Согласно протоколу QIWI OSMP v1.4, система всегда возвращает HTTP 200 OK и описывает результат операции в XML через поле `result`.

### Рекомендации по обработке ошибок

1. **Фатальные ошибки (4, 5, 7, 79, 241, 242, 243, 300):**
   - Не повторяйте запрос с теми же параметрами
   - Исправьте параметры запроса или обратитесь в поддержку

2. **Нефатальные ошибки (1, 90):**
   - Повторите запрос через некоторое время
   - Если ошибка повторяется, обратитесь в поддержку

3. **Успешный результат (0):**
   - Для команды `pay`: Сохраните `prv_txn` для сверки
   - Для команды `check`: Можете выполнять команду `pay`

---

## Технические детали реализации

### Архитектура

Backend реализован на .NET 8.0 (C#) и использует следующую архитектуру:

- **Controller:** `OptimaPaymentController` - обработка HTTP запросов
- **Service:** `OptimaPaymentService` - бизнес-логика обработки платежей
- **Helpers:**
  - `XmlResponseHelper` - генерация XML ответов
  - `IpAddressHelper` - проверка IP-адресов
  - `OptimaErrorHelper` - работа с кодами ошибок

### База данных

Все транзакции сохраняются в таблице `PaymentProviderTransactions`:
- `Qid` - идентификатор транзакции от банка (txn_id)
- `Provider` - "optima_bank"
- `OperationType` - "check" или "pay"
- `Account` - ID пользователя
- `Amount` - сумма платежа
- `TxnDate` - дата транзакции в формате `yyyyMMddHHmmss`
- `Status` - статус обработки ("success", "error")
- `RawRequest` - исходный запрос для сверки
- `InternalTransactionId` - ID внутренней транзакции (для команды pay)

### Логирование

Все операции логируются с использованием структурированного логирования:
- Уровень: `Information` для успешных операций
- Уровень: `Warning` для ошибок валидации
- Уровень: `Error` для критических ошибок

---

## Поддержка

При возникновении проблем или вопросов обращайтесь:
- Email: support@yess-loyalty.com
- Техническая поддержка: доступна в рабочее время

---

## История изменений

### Версия 1.0 (Текущая)
- Реализация протокола QIWI OSMP v1.4
- Поддержка команд `check` и `pay`
- Проверка IP-адресов
- Автоматическая генерация реестров сверки
- Идемпотентность операций
- Полное логирование и аудит

---

**Документ актуален на:** 2024-11-25  
**Версия документа:** 1.0
