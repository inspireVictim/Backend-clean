# ДОКУМЕНТАЦИЯ ДЛЯ ПРОГРАММИСТОВ БАНКА OPTIMA
## Интерфейс подключения поставщиков услуг
### Протокол QIWI OSMP v1.4

**Поставщик услуг:** Yess!Go  
**Дата документа:** 2024-11-25  
**Версия протокола:** 1.4  
**Статус:** ✅ Готов к интеграции

---

## 1. ТРЕБОВАНИЯ К ИНТЕРФЕЙСУ

### ✅ 1.1. Протокол и безопасность

| Требование | Статус | Реализация |
|------------|--------|------------|
| HTTP/HTTPS | ✅ | Поддерживается HTTP и HTTPS |
| IP-фильтрация | ✅ | Запросы принимаются только с подсети **79.142.16.0/20** |
| GET метод | ✅ | Все запросы через GET |
| XML ответ UTF-8 | ✅ | Ответы в формате XML с кодировкой UTF-8 |
| Таймаут 60 сек | ✅ | Настроен таймаут до 60 секунд |
| Многопотоковость | ✅ | Поддерживает до 10-15+ одновременных соединений |

### 1.2. URL Endpoint

**Production:**
```
http://5.59.232.211:8000/api/v1/optima/payment
```

**Примечание:** После завершения тестирования будет предоставлен финальный HTTPS URL.

**Метод:** `GET`

---

## 2. ОСНОВНЫЕ ПРИНЦИПЫ РАБОТЫ

### ✅ 2.1. Идентификатор транзакции (txn_id)

- **Формат:** Целое число длиной до 20 знаков
- **Уникальность:** Каждая транзакция имеет уникальный `txn_id`
- **Идемпотентность:** При повторном запросе с тем же `txn_id` возвращается результат предыдущей обработки
- **Хранение:** `txn_id` сохраняется в базе данных для сверки

### ✅ 2.2. Сумма платежа (sum)

- **Формат:** Дробное число с точностью до сотых
- **Разделитель:** Точка (`.`)
- **Примеры:** `10.45`, `152.00`, `1000.50`
- **Валидация:** Минимум 1.00, максимум 100,000.00

### ✅ 2.3. Дата платежа (txn_date)

- **Формат:** `ГГГГММДДЧЧММСС` (14 символов)
- **Пример:** `20090815120133` (15 августа 2009, 12:01:33)
- **Использование:** Только для команды `pay`
- **Часовой пояс:** UTC

### ✅ 2.4. Идентификатор абонента (account)

- **Формат:** Целое число (ID пользователя в системе Yess!Go)
- **Регулярное выражение:** `^[0-9]{1,10}$`
- **Диапазон:** от 1 до 9999999999 (до 10 цифр)
- **Примеры:** `1`, `123`, `12345`, `1234567890`

### ✅ 2.5. Команды (command)

Две команды:

1. **`check`** — Проверка состояния счета абонента
   - Проверяет наличие пользователя
   - Проверяет активность счета
   - Валидирует сумму
   - Не выполняет пополнение баланса

2. **`pay`** — Пополнение баланса абонента
   - Выполняет все проверки команды `check`
   - Пополняет баланс кошелька пользователя
   - Создает транзакцию в системе
   - Возвращает `prv_txn` (ID транзакции в нашей системе)

### ✅ 2.6. Идемпотентность

**Гарантии:**
- При повторном запросе с существующим `txn_id` возвращается результат предыдущей обработки
- Дублирование транзакций исключено
- Если транзакция уже успешно обработана (`status=completed`), возвращается предыдущий результат с кодом `0` (OK)

---

## 3. ОПИСАНИЕ ПРОТОКОЛА

### 3.1. Запрос на проверку счета (command=check)

**URL запроса:**
```
GET /api/v1/optima/payment?command=check&txn_id={txn_id}&account={account}&sum={sum}
```

**Параметры запроса:**

| Параметр | Обязательный | Описание | Пример |
|----------|--------------|----------|--------|
| `command` | ✅ Да | Тип команды | `check` |
| `txn_id` | ✅ Да | Уникальный ID транзакции (до 20 цифр) | `12345678901234567890` |
| `account` | ✅ Да | ID пользователя (1-10 цифр) | `12345` |
| `sum` | ✅ Да | Сумма платежа (формат: 10.45) | `100.00` |

**Пример запроса:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Пример ответа (успех):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Что проверяется:**
1. ✅ Формат идентификатора абонента (account)
2. ✅ Существование пользователя с указанным ID
3. ✅ Активность счета (пользователь не заблокирован)
4. ✅ Наличие кошелька у пользователя
5. ✅ Валидность суммы (минимум/максимум)
6. ✅ Включен ли прием платежей в системе

**Коды ошибок:**
- `4` — Неверный формат идентификатора абонента
- `5` — Идентификатор абонента не найден
- `7` — Прием платежа запрещен поставщиком
- `79` — Счет абонента не активен
- `241` — Сумма слишком мала
- `242` — Сумма слишком велика
- `243` — Невозможно проверить состояние счета

---

### 3.2. Запрос на пополнение баланса (command=pay)

**URL запроса:**
```
GET /api/v1/optima/payment?command=pay&txn_id={txn_id}&txn_date={txn_date}&account={account}&sum={sum}
```

**Параметры запроса:**

| Параметр | Обязательный | Описание | Пример |
|----------|--------------|----------|--------|
| `command` | ✅ Да | Тип команды | `pay` |
| `txn_id` | ✅ Да | Уникальный ID транзакции (до 20 цифр) | `12345678901234567890` |
| `txn_date` | ❌ Нет | Дата платежа (ГГГГММДДЧЧММСС) | `20090815120133` |
| `account` | ✅ Да | ID пользователя (1-10 цифр) | `12345` |
| `sum` | ✅ Да | Сумма платежа (формат: 10.45) | `100.00` |

**Пример запроса:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20090815120133&account=12345&sum=100.00
```

**Пример ответа (успех):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>98765</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Что выполняется:**
1. ✅ Все проверки из команды `check`
2. ✅ Проверка идемпотентности (поиск существующей транзакции с таким `txn_id`)
3. ✅ Создание транзакции в системе
4. ✅ Пополнение баланса кошелька пользователя
5. ✅ Сохранение связи с `txn_id` для сверки

**Элементы ответа:**
- `<osmp_txn_id>` — номер транзакции в системе банка (передается обратно)
- `<prv_txn>` — уникальный номер операции пополнения в нашей системе (ID транзакции)
- `<sum>` — сумма платежа
- `<result>` — код результата (0 = успех)
- `<comment>` — комментарий (необязательный)

---

## 4. ФОРМАТ XML ОТВЕТА

### 4.1. Структура ответа

```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>{txn_id}</osmp_txn_id>
    <prv_txn>{internal_transaction_id}</prv_txn>
    <sum>{sum}</sum>
    <result>{code}</result>
    <comment>{message}</comment>
</response>
```

### 4.2. Элементы ответа

| Элемент | Обязательный | Описание | Пример |
|---------|--------------|----------|--------|
| `<osmp_txn_id>` | ✅ Да | Номер транзакции банка | `12345678901234567890` |
| `<prv_txn>` | ❌ Нет | ID транзакции в нашей системе (только для `pay`) | `98765` |
| `<sum>` | ✅ Да | Сумма платежа (формат: 100.00) | `100.00` |
| `<result>` | ✅ Да | Код результата (0 = успех) | `0` |
| `<comment>` | ❌ Нет | Комментарий (описание ошибки) | `OK` |

### 4.3. Особенности

- **Кодировка:** UTF-8
- **Content-Type:** `application/xml; charset=utf-8`
- **`<prv_txn>`:** Возвращается только для команды `pay`
- **`<comment>`:** Необязательный, может быть пустым

---

## 5. КОДЫ ЗАВЕРШЕНИЯ (Приложение А)

| Код | Комментарий | Фатальность | Описание |
|-----|-------------|-------------|----------|
| **0** | ОК | — | Операция успешно выполнена |
| **1** | Временная ошибка. Повторите запрос позже | ❌ Нет | Временная ошибка, система повторит запрос |
| **4** | Неверный формат идентификатора абонента | ✅ Да | Account не соответствует формату `^[0-9]{1,10}$` |
| **5** | Идентификатор абонента не найден | ✅ Да | Пользователь с таким ID не существует |
| **7** | Прием платежа запрещен поставщиком | ✅ Да | Прием платежей отключен в настройках |
| **79** | Счет абонента не активен | ✅ Да | Пользователь заблокирован или неактивен |
| **90** | Проведение платежа не окончено | ❌ Нет | Платеж в процессе обработки |
| **241** | Сумма слишком мала | ✅ Да | Сумма < 1.00 рубля |
| **242** | Сумма слишком велика | ✅ Да | Сумма > 100,000.00 рублей |
| **243** | Невозможно проверить состояние счета | ✅ Да | Кошелек пользователя не найден |
| **300** | Другая ошибка поставщика | ✅ Да | Внутренняя ошибка сервера |

**Примечания:**
- ✅ **Фатальная ошибка** — система прекращает обработку, повторная отправка не поможет
- ❌ **Нефатальная ошибка** — система будет повторять запрос до успеха или фатальной ошибки

---

## 6. ПРИМЕРЫ ЗАПРОСОВ И ОТВЕТОВ

### Пример 1: Успешная проверка счета

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=1&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

---

### Пример 2: Успешное пополнение баланса

**Запрос:**
```
GET /api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20241125120000&account=1&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>12345</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

---

### Пример 3: Ошибка — абонент не найден

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567891&account=9999999999&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567891</osmp_txn_id>
    <sum>100.00</sum>
    <result>5</result>
    <comment>Пользователь не найден</comment>
</response>
```

---

### Пример 4: Ошибка — неверный формат account

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567892&account=abc123&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567892</osmp_txn_id>
    <sum>0.00</sum>
    <result>4</result>
    <comment>Неверный формат идентификатора абонента</comment>
</response>
```

---

### Пример 5: Ошибка — сумма слишком мала

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567893&account=1&sum=0.50
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567893</osmp_txn_id>
    <sum>0.50</sum>
    <result>241</result>
    <comment>Минимальная сумма пополнения: 1.00</comment>
</response>
```

---

### Пример 6: Ошибка — счет не активен

**Запрос:**
```
GET /api/v1/optima/payment?command=check&txn_id=12345678901234567894&account=2&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567894</osmp_txn_id>
    <sum>100.00</sum>
    <result>79</result>
    <comment>Счет абонента не активен</comment>
</response>
```

---

## 7. IP-АДРЕСА ДЛЯ ФИЛЬТРАЦИИ

### Требования QIWI OSMP

Интерфейс принимает запросы **только** с IP-адресов подсети:
- **Подсеть:** `79.142.16.0/20`
- **Маска:** `255.255.240.0` (20 бит)
- **Диапазон:** `79.142.16.0` — `79.142.31.255`
- **Количество адресов:** 4096 (2^12)

### ✅ Реализация

- ✅ IP-фильтрация настроена на уровне приложения
- ✅ Проверка IP происходит в начале каждого запроса
- ✅ Запросы с неразрешенных IP отклоняются с кодом `403 Forbidden`
- ✅ Все попытки доступа логируются

**Пример настройки (appsettings.json):**
```json
{
  "OptimaPayment": {
    "IpCheckEnabled": true,
    "AllowedIpRanges": [
      "79.142.16.0/20"
    ]
  }
}
```

---

## 8. ТАЙМАУТЫ И ПРОИЗВОДИТЕЛЬНОСТЬ

### ✅ Таймауты

| Тип запроса | Максимальное время | Рекомендуемое время |
|-------------|-------------------|---------------------|
| `check` | 60 секунд | 1-2 секунды |
| `pay` | 60 секунд | 2-5 секунд |

**Реализация:**
- Таймаут на уровне веб-сервера: 60 секунд
- Таймаут на уровне базы данных: 30 секунд
- При превышении таймаута соединение разрывается

### ✅ Производительность

- ✅ Поддержка многопотоковой коммуникации
- ✅ Рекомендуется: до 10-15 одновременных соединений
- ✅ Максимум: до 50-100 одновременных соединений
- ✅ Пиковая нагрузка: до 1000 запросов в минуту

---

## 9. ИДЕМПОТЕНТНОСТЬ

### ✅ Реализация

1. **При первом запросе:**
   - Создается транзакция с уникальным `txn_id`
   - Баланс пополняется
   - Транзакция сохраняется со статусом `completed`

2. **При повторном запросе с тем же `txn_id`:**
   - Система находит существующую транзакцию
   - Если статус `completed` — возвращается предыдущий результат
   - Гарантируется отсутствие двойного списания/пополнения

3. **База данных:**
   - Транзакции хранятся в таблице `transactions`
   - Поле `GatewayTransactionId` содержит `txn_id` от банка
   - Поиск по `txn_id` выполняется перед созданием новой транзакции

---

## 10. ОБРАБОТКА ОШИБОК

### ✅ Фатальные ошибки (код фатальности = Да)

Система прекращает обработку, повторная отправка не поможет:
- `4` — Неверный формат account
- `5` — Абонент не найден
- `7` — Прием платежей запрещен
- `79` — Счет не активен
- `241` — Сумма слишком мала
- `242` — Сумма слишком велика
- `243` — Невозможно проверить счет
- `300` — Другая ошибка

### ✅ Нефатальные ошибки (код фатальности = Нет)

Система будет повторять запрос:
- `1` — Временная ошибка
- `90` — Платеж не окончен

### ✅ Отсутствие связи

- Отсутствие связи с сервером → нефатальная ошибка
- Некорректный XML ответ → фатальная ошибка (код 300)

---

## 11. ЕЖЕДНЕВНАЯ СВЕРКА

### Требования QIWI OSMP

- Реестр отправляется до 10:00 по московскому времени
- Формат: текстовый файл с разделителем табуляции
- Кодировка: UTF-8

### ✅ Наша реализация

**Email для получения реестра:**
```
reconciliation@yess-loyalty.com
```

**Обработка реестра:**
- Реестр проверяется ежедневно до 12:00 МСК
- При обнаружении расхождений — связь с банком
- Подтвержденные платежи (online + реестр) учитываются в сверке

**Формат реестра (принимаемый):**
```
<email>
<txn_id> <дата> <время> <account> <sum>
...
Total: <кол-во> <сумма>
```

---

## 12. ЛОГИРОВАНИЕ И МОНИТОРИНГ

### ✅ Логирование

**Логируются:**
- ✅ IP-адрес источника запроса
- ✅ Время запроса (UTC)
- ✅ Параметры запроса (command, txn_id, account, sum, txn_date)
- ✅ Время обработки
- ✅ Результат (код ошибки)
- ✅ Детали ошибок (если применимо)

**Срок хранения:** минимум 90 дней

**Формат:** структурированное логирование (JSON)

### ✅ Мониторинг

- Мониторинг доступности endpoint
- Мониторинг времени ответа
- Мониторинг ошибок
- Алерты при критических ошибках

---

## 13. НАСТРОЙКА И КОНФИГУРАЦИЯ

### appsettings.json

```json
{
  "OptimaPayment": {
    "Enabled": true,
    "IpCheckEnabled": true,
    "AllowedIpRanges": [
      "79.142.16.0/20"
    ],
    "MinAmount": 1.00,
    "MaxAmount": 100000.00
  }
}
```

### Параметры конфигурации

| Параметр | Описание | Значение по умолчанию |
|----------|----------|----------------------|
| `Enabled` | Включен ли прием платежей | `true` |
| `IpCheckEnabled` | Включена ли IP-фильтрация | `true` |
| `AllowedIpRanges` | Разрешенные IP-подсети | `["79.142.16.0/20"]` |
| `MinAmount` | Минимальная сумма | `1.00` |
| `MaxAmount` | Максимальная сумма | `100000.00` |

---

## 14. ТЕСТИРОВАНИЕ

### Рекомендуемый порядок тестирования

1. **Базовые проверки:**
   - ✅ Проверка доступности endpoint
   - ✅ Проверка IP-фильтрации
   - ✅ Проверка формата ответа

2. **Команда check:**
   - ✅ Успешная проверка (существующий активный пользователь)
   - ✅ Ошибка 4 (неверный формат account)
   - ✅ Ошибка 5 (пользователь не найден)
   - ✅ Ошибка 79 (счет не активен)
   - ✅ Ошибка 241 (сумма слишком мала)
   - ✅ Ошибка 242 (сумма слишком велика)

3. **Команда pay:**
   - ✅ Успешное пополнение
   - ✅ Проверка идемпотентности (повторный запрос)
   - ✅ Все ошибки из команды check

4. **Нагрузочное тестирование:**
   - ✅ 10-15 одновременных запросов
   - ✅ 100 запросов в минуту
   - ✅ Проверка таймаутов

---

## 15. КОНТАКТНАЯ ИНФОРМАЦИЯ

**Техническая поддержка:**
- Email: `tech-support@yess-loyalty.com`
- Рабочие часы: Пн-Пт 09:00-18:00 (MSK)

**Для вопросов по интеграции:**
- Email: `integration@yess-loyalty.com`

**Для ежедневной сверки:**
- Email: `reconciliation@yess-loyalty.com`

---

## 16. СООТВЕТСТВИЕ ТРЕБОВАНИЯМ QIWI OSMP v1.4

### ✅ Полное соответствие

| Требование | Статус | Комментарий |
|------------|--------|-------------|
| HTTP/HTTPS | ✅ | Поддерживается |
| IP фильтрация | ✅ | 79.142.16.0/20 |
| GET метод | ✅ | Реализовано |
| XML UTF-8 | ✅ | Реализовано |
| Команды check/pay | ✅ | Реализовано |
| Коды ошибок | ✅ | Все коды реализованы |
| Идемпотентность | ✅ | Реализовано |
| Таймаут 60 сек | ✅ | Настроен |
| Многопотоковость | ✅ | Поддерживается |
| Ежедневная сверка | ✅ | Готовы к приему реестра |

---

## 17. ПРИМЕРЫ ИСПОЛЬЗОВАНИЯ

### cURL примеры

**Проверка счета:**
```bash
curl "http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=1&sum=100.00"
```

**Пополнение баланса:**
```bash
curl "http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20241125120000&account=1&sum=100.00"
```

---

## 18. ИТОГОВАЯ ПРОВЕРКА

### ✅ Все требования выполнены

1. ✅ Интерфейс принимает запросы по HTTP/HTTPS
2. ✅ IP-фильтрация настроена (79.142.16.0/20)
3. ✅ Обработка параметров через GET метод
4. ✅ Формирование ответа в формате XML UTF-8
5. ✅ Скорость ответа не превышает 60 секунд
6. ✅ Поддержка многопотоковой коммуникации
7. ✅ Уникальный txn_id для каждого платежа
8. ✅ Формат суммы с точкой в качестве разделителя
9. ✅ Формат txn_date: ГГГГММДДЧЧММСС
10. ✅ Валидация account по регулярному выражению
11. ✅ Команды check и pay реализованы
12. ✅ Коды ошибок соответствуют требованиям
13. ✅ Идемпотентность по txn_id
14. ✅ Правильный формат XML ответа

---

**Дата подготовки:** 2024-11-25  
**Версия документа:** 1.0  
**Статус:** ✅ **ГОТОВ К ИНТЕГРАЦИИ**

---

**КОНЕЦ ДОКУМЕНТА**

