# Руководство по интеграции с YESS Loyalty для Optima Bank

**Версия документа:** 1.0  
**Дата:** 2024-11-26  
**Протокол:** QIWI OSMP v1.4

---

## СОДЕРЖАНИЕ

1. [Общая информация](#1-общая-информация)
2. [Соответствие требованиям QIWI OSMP v1.4](#2-соответствие-требованиям-qiwi-osmp-v14)
3. [Технические параметры интеграции](#3-технические-параметры-интеграции)
4. [Описание протокола](#4-описание-протокола)
5. [Коды завершения операций](#5-коды-завершения-операций)
6. [Ежедневная сверка](#6-ежедневная-сверка)
7. [Примеры запросов и ответов](#7-примеры-запросов-и-ответов)
8. [Обработка ошибок](#8-обработка-ошибок)

---

## 1. ОБЩАЯ ИНФОРМАЦИЯ

### 1.1. Назначение документа

Данный документ предназначен для сотрудников Optima Bank и содержит полное описание интерфейса подключения поставщика услуг YESS Loyalty, реализующего протокол QIWI OSMP версии 1.4.

### 1.2. Описание системы

YESS Loyalty — система лояльности, которая принимает платежи от Optima Bank для пополнения баланса пользователей. Система полностью соответствует требованиям протокола QIWI OSMP v1.4.

### 1.3. Основные возможности

- ✅ Прием платежей через протокол QIWI OSMP v1.4
- ✅ Проверка состояния счета абонента (команда `check`)
- ✅ Пополнение баланса абонента (команда `pay`)
- ✅ Ежедневная автоматическая сверка платежей
- ✅ Поддержка многопоточной обработки (до 15 одновременных соединений)
- ✅ Идемпотентность операций (обработка дубликатов)
- ✅ Полное логирование всех операций

---

## 2. СООТВЕТСТВИЕ ТРЕБОВАНИЯМ QIWI OSMP V1.4

### 2.1. Требования к интерфейсу поставщика

| Требование | Статус | Описание |
|------------|--------|----------|
| **HTTP/HTTPS** | ✅ | Интерфейс принимает запросы по протоколу HTTP/HTTPS |
| **IP-фильтрация** | ✅ | Запросы принимаются только с IP-адресов подсети **79.142.16.0/20** |
| **Метод запросов** | ✅ | Обработка параметров методом **GET** |
| **Формат ответа** | ✅ | Ответ в формате **XML в кодировке UTF-8** |
| **Скорость ответа** | ✅ | Время ответа не превышает **60 секунд** |
| **Многопоточность** | ✅ | Поддержка до **15 одновременных соединений** |

### 2.2. Основные принципы работы

| Принцип | Реализация |
|---------|------------|
| **Уникальный идентификатор платежа** | Передается в переменной `txn_id` (до 20 цифр) |
| **Сумма платежа** | Передается в переменной `sum` (формат: `10.45`, всегда с точкой и двумя десятичными знаками) |
| **Дата платежа** | Передается в переменной `txn_date` (формат: `ГГГГММДДЧЧММСС`) |
| **Идентификатор абонента** | Передается в переменной `account` (до 50 символов, буквы, цифры, спецсимволы) |
| **Двухэтапная обработка** | Сначала `check` (проверка), затем `pay` (пополнение) |
| **Идемпотентность** | При повторном запросе с тем же `txn_id` возвращается результат предыдущей обработки |

### 2.3. Формат XML-ответа

Все ответы возвращаются в следующем формате:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>42</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Порядок элементов:**
1. `osmp_txn_id` — всегда присутствует
2. `prv_txn` — только для команды `pay` (если операция успешна)
3. `sum` — всегда присутствует
4. `result` — всегда присутствует
5. `comment` — всегда присутствует (может быть пустым)

---

## 3. ТЕХНИЧЕСКИЕ ПАРАМЕТРЫ ИНТЕГРАЦИИ

### 3.1. Адрес сервера для отправки запросов

**IP-адрес сервера:** `5.59.232.211`  
**Шлюз:** `5.59.232.1`  
**Маска подсети:** `255.255.255.0`

**Базовый URL для запросов:**

```
http://5.59.232.211:8000/api/v1/optima/payment
```

или (если настроен HTTPS):

```
https://5.59.232.211:8443/api/v1/optima/payment
```

**Примечание:** Если используется доменное имя, оно должно резолвиться в IP-адрес `5.59.232.211`.

### 3.2. IP-адреса для отправки запросов

**Важно:** Система принимает запросы **только** с IP-адресов подсети Optima Bank.

**Подсеть Optima Bank:** `79.142.16.0/20` (маска `255.255.240.0`)

**Диапазон IP-адресов Optima Bank:** `79.142.16.0` — `79.142.31.255`

**Требование:** Все запросы должны отправляться **с IP-адресов** из указанной подсети Optima Bank **на сервер** `5.59.232.211`.

### 3.3. Параметры запроса

Все параметры передаются методом **GET** в query string.

#### Обязательные параметры:

| Параметр | Тип | Описание | Пример |
|----------|-----|----------|--------|
| `command` | string | Тип команды: `check` или `pay` | `check` |
| `txn_id` | string | Уникальный идентификатор транзакции (до 20 цифр) | `12345678901234567890` |
| `account` | string | Идентификатор абонента (до 50 символов) | `12345` |
| `sum` | string | Сумма платежа (формат: `10.45`) | `100.00` |

#### Опциональные параметры:

| Параметр | Тип | Описание | Пример |
|----------|-----|----------|--------|
| `txn_date` | string | Дата платежа (только для `pay`, формат: `ГГГГММДДЧЧММСС`) | `20241125120000` |

### 3.4. Таймауты

- **Таймаут ответа:** 60 секунд
- **Таймаут соединения:** 60 секунд
- **Таймаут базы данных:** 30 секунд

### 3.5. Многопоточность

Система поддерживает обработку до **15 одновременных соединений**.

### 3.6. Проверка доступности сервера

Перед началом интеграции рекомендуется проверить доступность сервера:

**Проверка ping:**
```bash
ping 5.59.232.211
```

**Проверка HTTP-доступности:**
```bash
curl http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=test&account=1&sum=1.00
```

**Важно:** Запросы должны отправляться **с IP-адресов подсети Optima Bank** (`79.142.16.0/20`). Запросы с других IP-адресов будут отклонены.

---

## 4. ОПИСАНИЕ ПРОТОКОЛА

### 4.1. Команда `check` (проверка состояния счета)

**Назначение:** Проверка возможности пополнения баланса абонента.

**Параметры запроса:**
- `command=check` (обязательно)
- `txn_id` (обязательно)
- `account` (обязательно)
- `sum` (обязательно)

**Пример запроса:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Пример успешного ответа:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Примечание:** Элемент `<prv_txn>` в ответе на команду `check` **не возвращается** (согласно требованиям протокола).

### 4.2. Команда `pay` (пополнение баланса)

**Назначение:** Пополнение баланса абонента на указанную сумму.

**Параметры запроса:**
- `command=pay` (обязательно)
- `txn_id` (обязательно)
- `account` (обязательно)
- `sum` (обязательно)
- `txn_date` (опционально, но рекомендуется)

**Пример запроса:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20241125120000&account=12345&sum=100.00
```

**Пример успешного ответа:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>42</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Примечание:** Элемент `<prv_txn>` содержит уникальный идентификатор транзакции в системе YESS Loyalty и возвращается только при успешной операции.

### 4.3. Обработка дубликатов (идемпотентность)

Если система получает повторный запрос с уже существующим `txn_id`, который был успешно обработан ранее, система **не выполняет повторное пополнение**, а возвращает результат предыдущей обработки.

**Пример повторного запроса:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Ответ (тот же, что и при первой обработке):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>42</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>Платеж уже был обработан ранее</comment>
</response>
```

---

## 5. КОДЫ ЗАВЕРШЕНИЯ ОПЕРАЦИЙ

### 5.1. Таблица кодов завершения

| Код | Описание | Фатальность | Действие системы |
|-----|----------|-------------|-----------------|
| **0** | OK | - | Операция успешно выполнена |
| **1** | Временная ошибка. Повторите запрос позже | ❌ Нет | Система будет повторять запрос с увеличивающимся интервалом |
| **4** | Неверный формат идентификатора абонента | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **5** | Идентификатор абонента не найден (Ошиблись номером) | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **7** | Прием платежа запрещен поставщиком | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **79** | Счет абонента не активен | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **90** | Проведение платежа не окончено | ❌ Нет | Система будет повторять запрос для проверки статуса |
| **241** | Сумма слишком мала | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **242** | Сумма слишком велика | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **243** | Невозможно проверить состояние счета | ✅ Да | Система прекращает обработку, повторная отправка не поможет |
| **300** | Другая ошибка поставщика | ✅ Да | Система прекращает обработку, повторная отправка не поможет |

### 5.2. Фатальные и нефатальные ошибки

**Фатальные ошибки (✅):**
- Система **не выполняет** повторные попытки
- Повторная отправка запроса с теми же параметрами приведет к 100% повторению той же ошибки
- Система прекращает обработку клиентского запроса и завершает его с ошибкой

**Нефатальные ошибки (❌):**
- Система **повторяет** запрос с увеличивающимся интервалом (exponential backoff)
- Повторение запроса через некоторый промежуток времени может привести к успеху
- Система прекращает повторные попытки при:
  - Успешном завершении операции
  - Получении фатальной ошибки
  - Истечении срока жизни запроса (24 часа)

### 5.3. Примеры ответов с ошибками

#### Пример 1: Неверный формат идентификатора (код 4)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>4</result>
    <comment>Неверный формат идентификатора абонента</comment>
</response>
```

#### Пример 2: Абонент не найден (код 5)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567891</osmp_txn_id>
    <sum>100.00</sum>
    <result>5</result>
    <comment>Пользователь не найден</comment>
</response>
```

#### Пример 3: Сумма слишком мала (код 241)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567892</osmp_txn_id>
    <sum>0.50</sum>
    <result>241</result>
    <comment>Минимальная сумма пополнения: 1.00</comment>
</response>
```

#### Пример 4: Временная ошибка (код 1)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567893</osmp_txn_id>
    <sum>100.00</sum>
    <result>1</result>
    <comment>Временная ошибка. Повторите запрос позже</comment>
</response>
```

---

## 6. ЕЖЕДНЕВНАЯ СВЕРКА

### 6.1. Общая информация

Система YESS Loyalty автоматически генерирует и отправляет реестр платежей за предыдущий день до **10:00 по московскому времени (MSK, UTC+3)**.

### 6.2. Email для получения реестра

**Email адрес:** `reconciliation@yess-loyalty.com`

**Важно:** Убедитесь, что данный email адрес добавлен в список получателей реестров.

### 6.3. Формат реестра

Реестр отправляется в формате **TAB-разделенных значений (TSV)** в кодировке **UTF-8**.

**Структура реестра:**

1. **Первая строка:** Email адрес получателя
2. **Вторая строка:** Пустая строка
3. **Данные платежей:** Каждая строка содержит:
   - `txn_id` (TAB)
   - `дата` в формате `ДД.ММ.ГГГГ` (TAB)
   - `время` в формате `ЧЧ:ММ:СС` (TAB)
   - `идентификатор абонента` (TAB)
   - `сумма` в формате `100.00`
4. **Итоговая строка:** `Total: <количество платежей> <общая сумма>`

**Пример реестра:**
```
reconciliation@yess-loyalty.com

12345678901234567890	31.01.2024	12:13:14	12345	123.45
12345678901234567891	31.01.2024	13:22:34	12346	100.00
12345678901234567892	31.01.2024	14:55:11	12347	50.00
Total:	3	273.45
```

### 6.4. Правила включения в реестр

**Включаются в реестр:**
- ✅ Платежи, которые были успешно обработаны (статус `success`)
- ✅ Платежи, которые пришли как при online обмене сообщениями, так и в реестре

**Не включаются в реестр:**
- ❌ Платежи с ошибками
- ❌ Платежи со статусом `pending`
- ❌ Платежи команды `check` (только `pay`)

### 6.5. Обработка реестра

**Время обработки:** Реестр должен быть обработан до **12:00 по московскому времени**.

**Действия при получении реестра:**

1. ✅ Сверьте платежи из реестра с платежами в вашей базе данных
2. ✅ Проверьте наличие всех платежей из реестра в вашей системе
3. ✅ Проверьте отсутствие платежей в реестре, которые есть в вашей системе
4. ✅ При обнаружении расхождений свяжитесь с технической поддержкой YESS Loyalty

**Важно:** Если реестр не получен до 12:00 МСК, необходимо связаться с технической поддержкой.

---

## 7. ПРИМЕРЫ ЗАПРОСОВ И ОТВЕТОВ

### 7.1. Полный цикл обработки платежа

#### Шаг 1: Проверка состояния счета (`check`)

**Запрос:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

#### Шаг 2: Пополнение баланса (`pay`)

**Запрос:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20241125120000&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>42</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

### 7.2. Примеры различных сценариев

#### Сценарий 1: Успешная обработка

**Запрос `check`:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

**Запрос `pay`:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20241125120000&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>42</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

#### Сценарий 2: Абонент не найден

**Запрос:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567891&account=99999&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567891</osmp_txn_id>
    <sum>100.00</sum>
    <result>5</result>
    <comment>Пользователь не найден</comment>
</response>
```

#### Сценарий 3: Неверный формат идентификатора

**Запрос:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567892&account=abc123&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567892</osmp_txn_id>
    <sum>100.00</sum>
    <result>4</result>
    <comment>Неверный формат идентификатора абонента</comment>
</response>
```

#### Сценарий 4: Сумма слишком мала

**Запрос:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567893&account=12345&sum=0.50
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567893</osmp_txn_id>
    <sum>0.50</sum>
    <result>241</result>
    <comment>Минимальная сумма пополнения: 1.00</comment>
</response>
```

#### Сценарий 5: Повторный запрос (идемпотентность)

**Запрос (повторный с тем же txn_id):**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>42</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>Платеж уже был обработан ранее</comment>
</response>
```

---

## 8. ОБРАБОТКА ОШИБОК

### 8.1. Типы ошибок

#### Фатальные ошибки

Фатальные ошибки означают, что повторная отправка запроса с теми же параметрами приведет к 100% повторению той же ошибки. Система прекращает обработку клиентского запроса.

**Коды фатальных ошибок:** 4, 5, 7, 79, 241, 242, 243, 300

**Действие:** Система не выполняет повторные попытки.

#### Нефатальные ошибки

Нефатальные ошибки означают, что повторение запроса через некоторый промежуток времени может привести к успеху.

**Коды нефатальных ошибок:** 1, 90

**Действие:** Система повторяет запрос с увеличивающимся интервалом (exponential backoff).

### 8.2. Обработка отсутствия связи

**Отсутствие связи с сервером поставщика** является **нефатальной ошибкой**. Система будет повторять запросы до успеха или до истечения срока жизни запроса (24 часа).

**Отсутствие в ответе элемента `<result>`** (некорректный XML, страница "Service temporarily unavailable" и т.д.) является **фатальной ошибкой**. Запросы получают отказ с ошибкой 300 (другая ошибка поставщика).

### 8.3. Рекомендации по обработке ошибок

1. ✅ **Всегда проверяйте код `result`** в ответе
2. ✅ **Для фатальных ошибок** — не повторяйте запрос с теми же параметрами
3. ✅ **Для нефатальных ошибок** — повторите запрос через некоторое время
4. ✅ **Логируйте все ошибки** для последующего анализа
5. ✅ **При ошибке 300** — свяжитесь с технической поддержкой

---

## ПРИЛОЖЕНИЕ A: ЧЕКЛИСТ ИНТЕГРАЦИИ

### Шаг 1: Подготовка

- [ ] Получен IP-адрес сервера YESS Loyalty: `5.59.232.211`
- [ ] Настроена отправка запросов **с** IP-адресов подсети `79.142.16.0/20` **на** сервер `5.59.232.211:8000`
- [ ] Настроен email для получения реестров: `reconciliation@yess-loyalty.com`
- [ ] Изучена документация QIWI OSMP v1.4
- [ ] Проверена сетевая доступность сервера `5.59.232.211` с IP-адресов банка

### Шаг 2: Тестирование

- [ ] Протестирована команда `check` с валидными данными
- [ ] Протестирована команда `pay` с валидными данными
- [ ] Протестирована обработка ошибок (коды 4, 5, 241, 242)
- [ ] Протестирована идемпотентность (повторный запрос с тем же `txn_id`)
- [ ] Протестирована обработка неверных параметров

### Шаг 3: Настройка сверки

- [ ] Настроен прием email с реестрами
- [ ] Протестирован формат реестра
- [ ] Настроена автоматическая обработка реестров
- [ ] Настроено уведомление о расхождениях

### Шаг 4: Запуск в продакшн

- [ ] Проведено нагрузочное тестирование
- [ ] Настроен мониторинг ошибок
- [ ] Настроено логирование всех операций
- [ ] Получено подтверждение от YESS Loyalty о готовности к работе

---

## ПРИЛОЖЕНИЕ B: БЫСТРАЯ СПРАВКА

### Формат запроса

```
GET http://5.59.232.211:8000/api/v1/optima/payment?command={command}&txn_id={txn_id}&account={account}&sum={sum}&txn_date={txn_date}
```

**Полный пример:**
```
GET http://5.59.232.211:8000/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.00
```

### Формат ответа

```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>{txn_id}</osmp_txn_id>
    <prv_txn>{internal_id}</prv_txn>
    <sum>{sum}</sum>
    <result>{code}</result>
    <comment>{message}</comment>
</response>
```

### Коды результата

- `0` — OK
- `1` — Временная ошибка (нефатальная)
- `4` — Неверный формат идентификатора (фатальная)
- `5` — Абонент не найден (фатальная)
- `7` — Прием платежа запрещен (фатальная)
- `79` — Счет не активен (фатальная)
- `90` — Платеж не окончен (нефатальная)
- `241` — Сумма слишком мала (фатальная)
- `242` — Сумма слишком велика (фатальная)
- `243` — Невозможно проверить счет (фатальная)
- `300` — Другая ошибка (фатальная)

---

**Версия документа:** 1.0  
**Дата последнего обновления:** 2024-11-26  
**Статус:** Актуальная версия

