# ПАРАМЕТРЫ ИНТЕГРАЦИИ ПЛАТЁЖНОГО ШЛЮЗА OPTIMA BANK

**Поставщик услуг:** Yess!Go 
**Дата документа:** 2024  
**Версия:** 1.0  
**Статус:** Готов к интеграции

---

## ПОДТВЕРЖДЕНИЕ ГОТОВНОСТИ

Настоящим подтверждаем, что система **Yess!Go** готова к интеграции с платёжным шлюзом **Optima Bank** и реализует интерфейс подключения поставщиков услуг в соответствии с требованиями, изложенными в документе "Интерфейс подключения поставщиков услуг (вер. 1.4)".

---

## ТЕХНИЧЕСКИЕ ПАРАМЕТРЫ ИНТЕГРАЦИИ

### 1. URL Endpoint

**Production:**
```
https://api.yess-loyalty.com/api/v1/optima/payment
```

**Тестовая среда (для предварительного тестирования):**
```
https://test-api.yess-loyalty.com/api/v1/optima/payment
```

**Примечание:** Финальный production URL будет предоставлен после завершения тестирования и согласования с технической поддержкой банка.

### 2. Протокол и безопасность

- **Протокол:** HTTP или HTTPS
  - Поддержка HTTP для тестовых сред
  - **Рекомендуется:** HTTPS (TLS 1.2/1.3) для production
  - Минимальная версия TLS: 1.2
  - Рекомендуемая версия TLS: 1.3
- **Метод запроса:** GET
- **Формат ответа:** XML (UTF-8)
- **Content-Type ответа:** `application/xml; charset=utf-8`

### 3. IP-адреса для фильтрации

**IP-адреса, с которых банк будет отправлять запросы:**

Интерфейс принимает запросы **только** с IP-адресов подсети: **79.142.16.0/20**

**Параметры подсети:**
- Подсеть: `79.142.16.0/20`
- Маска подсети: `255.255.240.0` (20 бит)
- Диапазон IP-адресов: `79.142.16.0` — `79.142.31.255`
- Количество адресов: 4096 (2^12)

**Настройка IP-фильтрации:**
- IP-фильтрация настроена на уровне веб-сервера и приложения
- Запросы с IP-адресов, не входящих в указанную подсеть, отклоняются с кодом ошибки **403 Forbidden**
- Все попытки доступа с неразрешенных IP-адресов логируются для безопасности

### 4. Идентификатор абонента (account)

**Формат:** Целое число (ID пользователя в системе Yess!Go)

**Регулярное выражение:**
```
^[0-9]{1,10}$
```

**Описание:**
- Идентификатор абонента — это числовой ID пользователя в системе Yess!Go
- Диапазон значений: от 1 до 9999999999 (до 10 цифр)
- Примеры валидных идентификаторов: `1`, `123`, `12345`, `1234567890`

**Валидация:**
- При получении невалидного формата возвращается код ошибки **4** (Неверный формат идентификатора абонента)
- При отсутствии пользователя с указанным ID возвращается код ошибки **5** (Идентификатор абонента не найден)

### 5. Ограничения по сумме платежа

**Минимальная сумма:** 1.00 рубль  
**Максимальная сумма:** 100,000.00 рублей

**Валидация:**
- Сумма меньше 1.00 рубля → код ошибки **241** (Сумма слишком мала)
- Сумма больше 100,000.00 рублей → код ошибки **242** (Сумма слишком велика)

**Примечание:** Ограничения могут быть изменены по согласованию с банком.

### 6. Тайм-ауты

**Максимальное время ответа:**
- Запрос `check`: не более 5 секунд
- Запрос `pay`: не более 10 секунд
- Абсолютный максимум: 60 секунд (после чего соединение разрывается)

**Рекомендуемое время ответа:**
- Запрос `check`: 1-2 секунды
- Запрос `pay`: 2-5 секунд

### 7. Производительность

**Поддерживаемые нагрузки:**
- Минимум: 10-15 одновременных соединений
- Рекомендуется: до 50-100 одновременных соединений
- Пиковая нагрузка: до 1000 запросов в минуту

**Rate limiting:**
- Применяется на стороне системы Yess!Go
- Лимиты: 100 запросов в минуту, 1000 запросов в час с одного IP-адреса
- При превышении лимита возвращается код ошибки **1** (Временная ошибка)

### 8. Идемпотентность

Система обеспечивает полную идемпотентность операций:
- При повторном запросе с тем же `txn_id` возвращается результат предыдущей обработки
- Дублирование транзакций исключено
- Гарантируется атомарность операций пополнения баланса

### 9. Логирование

**Все операции логируются:**
- IP-адрес источника запроса
- Время запроса (UTC)
- Параметры запроса (txn_id, account, sum, command)
- Время обработки
- Результат обработки (код ошибки)
- Детали ошибок (если применимо)

**Срок хранения логов:** минимум 90 дней

**Формат логов:** структурированное логирование (JSON)

### 10. Ежедневная сверка

**Email для получения реестра:**
```
reconciliation@yess-loyalty.com
```

**Время обработки реестра:**
- Реестр обрабатывается ежедневно до 12:00 по московскому времени
- При обнаружении расхождений связываемся с контактным лицом банка до 12:00

**Формат реестра:**
- Принимается формат, указанный в требованиях банка
- Разделитель полей: знак табуляции (TAB)
- Кодировка: UTF-8

---

## ПРИМЕРЫ ЗАПРОСОВ И ОТВЕТОВ

### Пример 1: Успешная проверка счета (check)

**Запрос:**
```
GET https://api.yess-loyalty.com/api/v1/optima/payment?command=check&txn_id=12345678901234567890&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <sum>100.00</sum>
    <result>0</result>
    <comment></comment>
</response>
```

### Пример 2: Успешное пополнение баланса (pay)

**Запрос:**
```
GET https://api.yess-loyalty.com/api/v1/optima/payment?command=pay&txn_id=12345678901234567890&txn_date=20090815120133&account=12345&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567890</osmp_txn_id>
    <prv_txn>98765</prv_txn>
    <sum>100.00</sum>
    <result>0</result>
    <comment>OK</comment>
</response>
```

### Пример 3: Ошибка — абонент не найден

**Запрос:**
```
GET https://api.yess-loyalty.com/api/v1/optima/payment?command=check&txn_id=12345678901234567891&account=9999999999&sum=100.00
```

**Ответ:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
    <osmp_txn_id>12345678901234567891</osmp_txn_id>
    <sum>100.00</sum>
    <result>5</result>
    <comment>Идентификатор абонента не найден</comment>
</response>
```

---

## КОДЫ ОШИБОК

Система использует стандартные коды ошибок согласно требованиям:

| Код | Описание | Фатальность |
|-----|----------|-------------|
| 0 | ОК | — |
| 1 | Временная ошибка. Повторите запрос позже | Нет |
| 4 | Неверный формат идентификатора абонента | Да |
| 5 | Идентификатор абонента не найден | Да |
| 7 | Прием платежа запрещен поставщиком | Да |
| 79 | Счет абонента не активен | Да |
| 90 | Проведение платежа не окончено | Нет |
| 241 | Сумма слишком мала | Да |
| 242 | Сумма слишком велика | Да |
| 243 | Невозможно проверить состояние счета | Да |
| 300 | Другая ошибка поставщика | Да |

---

## КОНТАКТНАЯ ИНФОРМАЦИЯ

**Техническая поддержка:**
- Email: `tech-support@yess-loyalty.com`
- Телефон: *указать при необходимости*

**Для вопросов по интеграции:**
- Email: `integration@yess-loyalty.com`

**Для ежедневной сверки:**
- Email: `reconciliation@yess-loyalty.com`

**Рабочие часы технической поддержки:**
- Понедельник — Пятница: 09:00 — 18:00 (MSK)
- Экстренная поддержка: 24/7 для критических инцидентов

---

## ПЛАН ИНТЕГРАЦИИ

### Этап 1: Тестирование (1-2 недели)
- Настройка тестовой среды
- Обмен тестовыми запросами
- Проверка всех сценариев (успешные и ошибочные)
- Сверка форматов запросов/ответов

### Этап 2: Настройка production (1 неделя)
- Настройка production endpoint
- Настройка IP-фильтрации
- Настройка мониторинга и алертинга
- Финальное тестирование

### Этап 3: Запуск в production
- Переход на production endpoint
- Мониторинг первых транзакций
- Ежедневная сверка

---

## ТРЕБУЕМАЯ ИНФОРМАЦИЯ ОТ БАНКА

Для завершения настройки интеграции требуется предоставить:

1. ✅ **IP-адреса/подсети банка:** Получено
   - Подсеть: `79.142.16.0/20` (маска 255.255.240.0)

2. **Production URL:**
   - Подтверждение финального production URL или указание необходимости использования тестового URL

3. **Контактная информация:**
   - Контактное лицо для технических вопросов
   - Контактное лицо для вопросов по сверке
   - Контактное лицо для экстренных ситуаций

4. **Дополнительные требования:**
   - Специфические требования безопасности (если есть)
   - Дополнительные параметры запросов (если есть)
   - Специфические форматы ответов (если есть)

---

## СТАТУС ГОТОВНОСТИ

✅ Интерфейс реализован и протестирован  
✅ Поддержка протокола check/pay  
✅ Валидация всех параметров  
✅ Обработка всех кодов ошибок  
✅ Идемпотентность операций  
✅ Логирование всех операций  
✅ Получена информация об IP-адресах банка (79.142.16.0/20)  
✅ IP-фильтрация реализована и настроена  
⏳ Ожидается подтверждение production URL  

---

**Дата подготовки документа:** 2024  
**Версия:** 1.0  
**Статус:** Готов к интеграции

---

**Конец документа**

